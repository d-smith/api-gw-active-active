AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Create a code pipeline for serverless sample app

Parameters:
  CodePipelineServiceRole:
    Type: String
    Description: >
      Role the code pipeline runs under. See the code pipeline docs
      for information on how to set this up.
  OAuthToken:
    Type: String
    Description: OAuthToken from source provider needed to access repo
    NoEcho: true

  BuildProjectName:
    Type: String
    Description: CodeBuild project name for build part of stage

  DeployProjectName:
    Type: String
    Description: CodeBuild project name for deploy part of stage

Resources:

  MyArtifactBucket:
    Type: AWS::S3::Bucket

  ServerlessPipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn: !Ref CodePipelineServiceRole
      Stages:
        -
          Name: Source
          Actions:
            -
              Name: SourceAction
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Version: 1
                Provider: GitHub
              OutputArtifacts:
                -
                  Name: MyApp
              Configuration:
                Owner: xtraclabs
                Repo: api-gw-active-standby
                PollForSourceChanges: false
                Branch: master
                OAuthToken: !Ref OAuthToken
              RunOrder: 1
        -
          Name: Build
          Actions:
            -
              Name: BuildAction
              InputArtifacts:
                -
                  Name: MyApp
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: 1
                Provider: CodeBuild
              OutputArtifacts:
                -
                  Name: MyAppBuild
              Configuration:
                ProjectName: !Ref BuildProjectName
        -
          Name: Deploy
          Actions:
            -
              Name: DeployAction
              InputArtifacts:
                -
                  Name: MyAppBuild
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: 1
                Provider: CodeBuild
              Configuration:
                ProjectName: !Ref DeployProjectName
      ArtifactStore:
        Type: S3
        Location: !Ref MyArtifactBucket       
      Name: ServerlessPipeline
