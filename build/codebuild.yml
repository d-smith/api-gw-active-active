AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Create an IAM role to use for code build for serverless builds

Resources:

  CodeBuildServerlessRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [codebuild.amazonaws.com]
          Action: ['sts:AssumeRole']
      Path: /
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AmazonS3FullAccess 
      - arn:aws:iam::aws:policy/AWSLambdaFullAccess
      - arn:aws:iam::aws:policy/AmazonAPIGatewayAdministrator

  CFPolicy:
    Type: "AWS::IAM::Policy"
    DependsOn: CodeBuildServerlessRole
    Properties: 
      PolicyName: "CFCodeBuild"
      PolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - 
            Effect: "Allow"
            Action: 
              - "cloudformation:*"
            Resource: "*"
      Roles:
        -
          Ref: "CodeBuildServerlessRole"

  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: apiGWSample
      Description: build project (and ci skeleton) for gw sample
      ServiceRole: !GetAtt CodeBuildServerlessRole.Arn
      Artifacts:
        Type: no_artifacts
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/eb-nodejs-6.10.0-amazonlinux-64:4.0.0
      Source:
        Location: https://github.com/xtraclabs/api-gw-active-standby
        Type: GITHUB
      TimeoutInMinutes: 10
      
Outputs:

  CodeBuildServerlessRole:
    Value: !GetAtt CodeBuildServerlessRole.Arn